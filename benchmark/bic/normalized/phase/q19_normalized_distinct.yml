SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 19 (distinct) via MongoDB BIC

q19_normalized_distinct_aggregation: &q19_normalized_distinct_aggregation
  aggregate: part
  pipeline:
    [
      { "$lookup": { "from": "lineitem","let": { "local_table__p_partkey": "$p_partkey","local_table__p_brand": "$p_brand","local_table__p_container": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_size": "$p_size","local_table__p_size_0": "$p_size","local_table__p_partkey_0": "$p_partkey","local_table__p_brand_0": "$p_brand","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_size_0": "$p_size","local_table__p_size_0": "$p_size","local_table__p_partkey_0": "$p_partkey","local_table__p_brand_0": "$p_brand","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_container_0": "$p_container","local_table__p_size_0": "$p_size","local_table__p_size_0": "$p_size" },"pipeline": [ { "$match": { "$expr": { "$reduce": { "input": [ { "$let": { "vars": { "expr0": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_partkey",null ] },{ "$lte": [ "$l_partkey",null ] } ] },"then": null,"else": { "$eq": [ "$$local_table__p_partkey","$l_partkey" ] } } },"expr1": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_brand",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_brand","Brand#12" ] } } },"expr2": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","SM CASE" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","SM BOX" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","SM PACK" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","SM PKG" ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"expr3": { "$cond": { "if": { "$or": [ { "$lte": [ NumberLong("1"),null ] },{ "$lte": [ "$l_quantity",null ] } ] },"then": null,"else": { "$lte": [ NumberLong("1"),"$l_quantity" ] } } },"expr4": { "$cond": { "if": { "$or": [ { "$lte": [ "$l_quantity",null ] },{ "$lte": [ NumberLong("11"),null ] } ] },"then": null,"else": { "$lte": [ "$l_quantity",NumberLong("11") ] } } },"expr5": { "$cond": { "if": { "$or": [ false,{ "$lte": [ "$$local_table__p_size",null ] } ] },"then": null,"else": { "$lte": [ NumberLong("1"),"$$local_table__p_size" ] } } },"expr6": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_size",null ] },false ] },"then": null,"else": { "$lte": [ "$$local_table__p_size",NumberLong("5") ] } } },"expr7": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipmode",null ] },{ "$lte": [ "AIR",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipmode","AIR" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipmode",null ] },{ "$lte": [ "AIR REG",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipmode","AIR REG" ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"expr8": { "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipinstruct",null ] },{ "$lte": [ "DELIVER IN PERSON",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipinstruct","DELIVER IN PERSON" ] } } } },"in": { "$cond": { "if": { "$or": [ { "$eq": [ "$$expr0",NumberInt("0") ] },{ "$eq": [ "$$expr0",false ] },{ "$eq": [ "$$expr1",NumberInt("0") ] },{ "$eq": [ "$$expr1",false ] },{ "$eq": [ "$$expr2",NumberInt("0") ] },{ "$eq": [ "$$expr2",false ] },{ "$eq": [ "$$expr3",NumberInt("0") ] },{ "$eq": [ "$$expr3",false ] },{ "$eq": [ "$$expr4",NumberInt("0") ] },{ "$eq": [ "$$expr4",false ] },{ "$eq": [ "$$expr5",NumberInt("0") ] },{ "$eq": [ "$$expr5",false ] },{ "$eq": [ "$$expr6",NumberInt("0") ] },{ "$eq": [ "$$expr6",false ] },{ "$eq": [ "$$expr7",NumberInt("0") ] },{ "$eq": [ "$$expr7",false ] },{ "$eq": [ "$$expr8",NumberInt("0") ] },{ "$eq": [ "$$expr8",false ] } ] },"then": false,"else": { "$cond": { "if": { "$or": [ { "$lte": [ "$$expr0",null ] },{ "$lte": [ "$$expr1",null ] },{ "$lte": [ "$$expr2",null ] },{ "$lte": [ "$$expr3",null ] },{ "$lte": [ "$$expr4",null ] },{ "$lte": [ "$$expr5",null ] },{ "$lte": [ "$$expr6",null ] },{ "$lte": [ "$$expr7",null ] },{ "$lte": [ "$$expr8",null ] } ] },"then": null,"else": true } } } } } },{ "$let": { "vars": { "expr0": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_partkey",null ] },{ "$lte": [ "$l_partkey",null ] } ] },"then": null,"else": { "$eq": [ "$$local_table__p_partkey","$l_partkey" ] } } },"expr1": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_brand",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_brand","Brand#24" ] } } },"expr2": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","MED BAG" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","MED BOX" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","MED PKG" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","MED PACK" ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"expr3": { "$cond": { "if": { "$or": [ { "$lte": [ NumberLong("30"),null ] },{ "$lte": [ "$l_quantity",null ] } ] },"then": null,"else": { "$lte": [ NumberLong("30"),"$l_quantity" ] } } },"expr4": { "$cond": { "if": { "$or": [ { "$lte": [ "$l_quantity",null ] },{ "$lte": [ NumberLong("40"),null ] } ] },"then": null,"else": { "$lte": [ "$l_quantity",NumberLong("40") ] } } },"expr5": { "$cond": { "if": { "$or": [ false,{ "$lte": [ "$$local_table__p_size",null ] } ] },"then": null,"else": { "$lte": [ NumberLong("1"),"$$local_table__p_size" ] } } },"expr6": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_size",null ] },false ] },"then": null,"else": { "$lte": [ "$$local_table__p_size",NumberLong("10") ] } } },"expr7": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipmode",null ] },{ "$lte": [ "AIR",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipmode","AIR" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipmode",null ] },{ "$lte": [ "AIR REG",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipmode","AIR REG" ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"expr8": { "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipinstruct",null ] },{ "$lte": [ "DELIVER IN PERSON",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipinstruct","DELIVER IN PERSON" ] } } } },"in": { "$cond": { "if": { "$or": [ { "$eq": [ "$$expr0",NumberInt("0") ] },{ "$eq": [ "$$expr0",false ] },{ "$eq": [ "$$expr1",NumberInt("0") ] },{ "$eq": [ "$$expr1",false ] },{ "$eq": [ "$$expr2",NumberInt("0") ] },{ "$eq": [ "$$expr2",false ] },{ "$eq": [ "$$expr3",NumberInt("0") ] },{ "$eq": [ "$$expr3",false ] },{ "$eq": [ "$$expr4",NumberInt("0") ] },{ "$eq": [ "$$expr4",false ] },{ "$eq": [ "$$expr5",NumberInt("0") ] },{ "$eq": [ "$$expr5",false ] },{ "$eq": [ "$$expr6",NumberInt("0") ] },{ "$eq": [ "$$expr6",false ] },{ "$eq": [ "$$expr7",NumberInt("0") ] },{ "$eq": [ "$$expr7",false ] },{ "$eq": [ "$$expr8",NumberInt("0") ] },{ "$eq": [ "$$expr8",false ] } ] },"then": false,"else": { "$cond": { "if": { "$or": [ { "$lte": [ "$$expr0",null ] },{ "$lte": [ "$$expr1",null ] },{ "$lte": [ "$$expr2",null ] },{ "$lte": [ "$$expr3",null ] },{ "$lte": [ "$$expr4",null ] },{ "$lte": [ "$$expr5",null ] },{ "$lte": [ "$$expr6",null ] },{ "$lte": [ "$$expr7",null ] },{ "$lte": [ "$$expr8",null ] } ] },"then": null,"else": true } } } } } },{ "$let": { "vars": { "expr0": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_partkey",null ] },{ "$lte": [ "$l_partkey",null ] } ] },"then": null,"else": { "$eq": [ "$$local_table__p_partkey","$l_partkey" ] } } },"expr1": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_brand",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_brand","Brand#34" ] } } },"expr2": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","LG CASE" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","LG BOX" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","LG PACK" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","LG PKG" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_container",null ] },false ] },"then": null,"else": { "$eq": [ "$$local_table__p_container","WRAP BOX" ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"expr3": { "$cond": { "if": { "$or": [ { "$lte": [ NumberLong("20"),null ] },{ "$lte": [ "$l_quantity",null ] } ] },"then": null,"else": { "$lte": [ NumberLong("20"),"$l_quantity" ] } } },"expr4": { "$cond": { "if": { "$or": [ { "$lte": [ "$l_quantity",null ] },{ "$lte": [ NumberLong("30"),null ] } ] },"then": null,"else": { "$lte": [ "$l_quantity",NumberLong("30") ] } } },"expr5": { "$cond": { "if": { "$or": [ false,{ "$lte": [ "$$local_table__p_size",null ] } ] },"then": null,"else": { "$lte": [ NumberLong("1"),"$$local_table__p_size" ] } } },"expr6": { "$cond": { "if": { "$or": [ { "$lte": [ "$$local_table__p_size",null ] },false ] },"then": null,"else": { "$lte": [ "$$local_table__p_size",NumberLong("15") ] } } },"expr7": { "$reduce": { "input": [ { "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipmode",null ] },{ "$lte": [ "AIR",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipmode","AIR" ] } } },{ "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipmode",null ] },{ "$lte": [ "AIR REG",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipmode","AIR REG" ] } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } },"expr8": { "$cond": { "if": { "$or": [ { "$lte": [ "$l_shipinstruct",null ] },{ "$lte": [ "DELIVER IN PERSON",null ] } ] },"then": null,"else": { "$eq": [ "$l_shipinstruct","DELIVER IN PERSON" ] } } } },"in": { "$cond": { "if": { "$or": [ { "$eq": [ "$$expr0",NumberInt("0") ] },{ "$eq": [ "$$expr0",false ] },{ "$eq": [ "$$expr1",NumberInt("0") ] },{ "$eq": [ "$$expr1",false ] },{ "$eq": [ "$$expr2",NumberInt("0") ] },{ "$eq": [ "$$expr2",false ] },{ "$eq": [ "$$expr3",NumberInt("0") ] },{ "$eq": [ "$$expr3",false ] },{ "$eq": [ "$$expr4",NumberInt("0") ] },{ "$eq": [ "$$expr4",false ] },{ "$eq": [ "$$expr5",NumberInt("0") ] },{ "$eq": [ "$$expr5",false ] },{ "$eq": [ "$$expr6",NumberInt("0") ] },{ "$eq": [ "$$expr6",false ] },{ "$eq": [ "$$expr7",NumberInt("0") ] },{ "$eq": [ "$$expr7",false ] },{ "$eq": [ "$$expr8",NumberInt("0") ] },{ "$eq": [ "$$expr8",false ] } ] },"then": false,"else": { "$cond": { "if": { "$or": [ { "$lte": [ "$$expr0",null ] },{ "$lte": [ "$$expr1",null ] },{ "$lte": [ "$$expr2",null ] },{ "$lte": [ "$$expr3",null ] },{ "$lte": [ "$$expr4",null ] },{ "$lte": [ "$$expr5",null ] },{ "$lte": [ "$$expr6",null ] },{ "$lte": [ "$$expr7",null ] },{ "$lte": [ "$$expr8",null ] } ] },"then": null,"else": true } } } } } } ],"initialValue": false,"in": { "$switch": { "branches": [ { "case": { "$or": [ "$$this","$$value" ] },"then": true },{ "case": { "$eq": [ "$$this",null ] },"then": null },{ "case": { "$eq": [ "$$value",null ] },"then": null } ],"default": false } } } } } } ],"as": "__joined_lineitem" } },
      { "$unwind": "$__joined_lineitem" },
      { "$group": { "_id": { },"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$sum": { "$multiply": [ "$__joined_lineitem.l_extendedprice",{ "$subtract": [ NumberLong("1"),"$__joined_lineitem.l_discount" ] } ] } },"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count": { "$sum": { "$cond": { "if": { "$lte": [ { "$multiply": [ "$__joined_lineitem.l_extendedprice",{ "$subtract": [ NumberLong("1"),"$__joined_lineitem.l_discount" ] } ] },null ] },"then": NumberInt("0"),"else": NumberInt("1") } } } } },
      { "$project": { "_id": NumberInt("0"),"sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": { "$cond": { "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count","then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)","else": { "$literal": null } } } } },
      { "$group": { "_id": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)" } },
      { "$addFields": { "_id": { "group_key_0": "$_id" } } },
      { "$project": { "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": "$_id.group_key_0","_id": NumberInt("0") } },
    ]
  cursor: {}

q19_normalized_distinct:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand: *q19_normalized_distinct_aggregation
